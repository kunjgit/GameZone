<script src=./aframe.min.js></script><script>function e(e){var t=document.createElement("canvas");return t.width=t.height=e,{canvas:t,ctx:t.getContext("2d")}}function t(t){var{canvas:i,ctx:o}=e(256),n=o.createRadialGradient(128,128,128*t,128,128,128*(t+.25));return n.addColorStop(0,"rgba(0,0,0,.33)"),n.addColorStop(1,"rgba(0,0,0,0)"),o.fillStyle=n,o.fillRect(0,0,255,255),new te.MeshBasicMaterial({map:new te.CanvasTexture(i),side:2,transparent:!0})}function i(t){var{canvas:i,ctx:o}=e(32);return o.strokeStyle="#fff",o.fillStyle="#fff",o.lineWidth=3,o.beginPath(),o.arc(16,16,14,0,2*H),o.stroke(),t&&o.fill(),o.beginPath(),o.arc(12,10,4,0,2*H),o.stroke(),o.fill(),new te.CanvasTexture(i)}function o(){var{canvas:t,ctx:i}=e(256);i.strokeStyle="yellow",i.fillStyle="#000",i.fillRect(0,0,255,255),i.lineWidth=42;for(var o=0;12>o;o++)i.beginPath(),i.moveTo(128*o-256,-64),i.lineTo(128*o-256+256+128,320),i.stroke();return i.fillStyle="#888",i.fillRect(0,0,255,10),new te.CanvasTexture(t,300,1e3)}function n(e,t,i,o,a,r,s,l){e.lineWidth=t,e.shadowBlur=16,e.beginPath(),e.moveTo(i,o),i+=$(a)*s,o+=K(a)*s,e.lineTo(i,o),e.stroke(),l&&n(e,.75*t,i,o,a+Math.random()*r-r/2,r/2,.6*s,l-1)}function a(e){return e.reduce((e,t)=>(e[t[0]]=new te.Vector3(...t[1]),e),{})}function r(e){return a([["-y",[.5,e,.5]],["+y",[.5,1-e,.5]],["-x",[e,.5,.5]],["+x",[1-e,.5,.5]],["-z",[.5,.5,e]],["+z",[.5,.5,1-e]]])}function s(e){return ot[e[0]]+e[1]}function l(e,t){nt[e]={tick:0,count:2,pools:[]};for(var i,o=0;o<2;o++)(i=new Audio).src=ie(t),nt[e].pools.push(i)}function c(e){var t=nt[e];t.pools[t.tick].play(),t.tick=(t.tick+1)%2}function p(e){mt+=e,document.getElementById("s").setAttribute("text",{value:"Score: "+mt+"\n\nOverflow Bonus: "+yt+"\nFlow Bonus: "+wt})}function d(){ht.push(mt),ht.sort((e,t)=>e-t).reverse().splice(10),localStorage.highScores=ht.join(",")}function u(e){return 0<e.x&&0<e.y&&0<e.z&&e.x<Ie.x+1&&e.y<Ie.y+1&&e.z<Ie.z+1}function h(e){return 0===e.x||0===e.y||0===e.z||e.x===Ie.x+1||e.y===Ie.y+1||e.z===Ie.z+1}function m(e){return u(e)||h(e)}function w(e,t){if(m(e)){var i=at[16*e.x*16+16*e.y+e.z],o=i&&i.components.pipe;return t?o&&!!o.data.isWire==!!t.data.isWire&&o:o}}function y(){return gt.forEach(e=>e.updatePipes()),rt=!gt.filter(e=>!e.data.isWire).every(e=>e.reachesGoal),st=!gt.filter(e=>e.data.isWire).every(e=>e.reachesGoal),gt.filter(e=>e.reachesGoal).length}function f(e){var t=new te.Vector3;xe.getWorldPosition(t).sub(Wi),e.add(t),xe.parent.worldToLocal(e);const i=.8*se+(vt?0:1.6);xe.position.set(e.x,i,e.z)}function v(e){ze.innerHTML="",ze.object3D.children=[],document.getElementById("i").setAttribute("visible","intro"===e),at=Array(4096).fill(0),Mt=[],document.getElementById("p").innerHTML="",document.getElementById("L").object3D.children=[],document.getElementById("b").object3D.children=[],function(e){Re[e].forEach(e=>{var t,i=new te.Vector3(...e.split("",3).map(e=>parseInt(e,16))),o=0,n=!1,a=!1,r=!1,s=re,l=!1,c=tt[e.slice(3,4)],p=e.slice(4),d={"/":()=>o/=2,g:()=>s=65280,r:()=>s=16711680,W:()=>(l=!0,o*=100),S:()=>a=!0,"^":()=>n=!0,G:()=>r=!0};for(var u in p){var h=p[u],m=tt[c],w=d[h],y=parseInt(h);if(w)w();else if(isNaN(y)){if(c=h,!a){var f=document.createElement("a-entity");f.setAttribute("position",i.clone()),f.setAttribute("pipe",{kind:it[m]+">"+it[c],place:!0,fillSpeed:o,amount:0<o?1:0,isSource:t,isGoal:r,isFilling:n,color:s,isWire:l}),Se.appendChild(f),n&&Mt.push(f)}i.add(He[it[c]]),a=!1,n=!1,r=!1,t=!1}else o=y,t=0<y}})}(e),we.reset();var{pos:t,dir:i}=Oe[e],o=new te.Vector3(...t);ze.object3D.localToWorld(o),f(o),xe.rotation.set(...i),gt=[],xt=1,lt=e,yt=1e3,rt=!0,st=!0,Rt=!1,Xe(),bi=null}function b(){Mt.forEach(e=>e.components.pipe.isFilling=!0)}async function g(e,t,i,o){return 1===t&&c("teleport"),zt=!0,he.color.set(e),new Promise(e=>{ue.visible=!0,new oe.Tween(he).to({opacity:t},1e3).delay(o||0).onComplete(e).start()}).then(()=>{ue.visible=!i,zt=!1})}function x(e){Me.setAttribute("text",{value:e}),Me.setAttribute("visible",!0)}function M(e){document.getElementById("I").setAttribute("text",{value:e}),document.getElementById("I").setAttribute("visible",!0)}function S(){document.getElementById("I").setAttribute("visible",!1)}function E(){Me.setAttribute("visible",!1)}async function k(e,t){await D(1),x(e),t?await A():await D(2),E()}async function j(e){c("warn"),x(e),await D(5),E()}async function z(e){for(c("notice"),pt=(Dt="CAPTAIN\n\n")+e,x(Dt),Me.setAttribute("text",{align:"left"});pt!==Dt;)x(Dt="click"===await Promise.race([A(),D(.02)])?pt:pt.substr(0,Dt.length+1));x(Dt+"\n\n[click to continue]"),await A(),E()}async function D(e){return new Promise(t=>setTimeout(t,1e3*e))}async function Z(){return new Promise(e=>window.addEventListener("grab-pipe",e))}async function A(){return new Promise(e=>window.addEventListener("click-triggered",()=>e("click")))}async function P(){return new Promise(e=>window.addEventListener("teleported",e))}async function V(){return new Promise(e=>window.addEventListener("start-game",e))}async function W(){return new Promise(e=>window.addEventListener("finish-level",t=>e(t.detail)))}async function G(){return new Promise(e=>window.addEventListener("place-pipe",e))}async function C(){await k("Game Over\nScore "+mt.toLocaleString()+"\n"+ut,!0),await g("#000",1,0,1e3)}async function Y(){kt=!1,v("room1"),await g("#88f",0,1),document.getElementById("s").setAttribute("visible",!0),ct=!1,b(),await D(1),await z("We are getting reports that small pockets of the ship have vanished after exiting the wormhole! Engine cooling, shields, and weapons are offline! Fix broken systems ASAP"),ct=!0,St=!0,bt=!0,kt=!0,(async()=>{await D(1),vt?(M("Fix both pipes before the engine coolant fills the room. Use the trigger to grab an empty pipe or create a new pipe piece"),await Z(),M("You can only have one active (green) pipe at once. Snap it into place before grabbing or creating a new pipe piece"),await G(),M("Long-press the thumbpad to give up if you get stuck")):(M("Fix both pipes before the engine coolant fills the room. Click on a pipe to grab it or click elsewhere to create a random pipe piece"),await Z(),M("Rotate with Q/E and R/F. Aim and click to place the pipe when it locks into place"),await G(),M("You can hold one pipe piece at once. Press L to give up if you get stuck")),await D(10),S()})(),await W()?(kt=!1,xt=1,await z("Engine cooling is back online and engines are charging up"),await g("#88f",1,0),await Zt.room2()):await C()}function B(e,t,i,o){return async function(){kt=!1,v(e),await g("#88f",0,1),ct=!0,St=!0,bt=!0,kt=!0,b(),t&&(async()=>{await D(2),M(t),await D(10),S()})(),await W()?(kt=!1,xt=1,await z(i),await g("#88f",1,0),o?await Zt[o]():(d(),await k("YOU WIN\nScore "+mt.toLocaleString(),!0))):await C()}}function T(e){ut=e,d(),bt=!1,window.dispatchEvent(new CustomEvent("finish-level",{detail:!1}))}function F(e,t,i){var o=new te.Mesh(e,t);return o.renderOrder=i,o}function I(e,t){if(!e.obj){var i=Array(e.count).fill(null).map(e.create),o=new te.Geometry;i.forEach(e=>o.vertices.push(e.position));var n=new te.Points(o,e.material);n.renderOrder=e.renderOrder,n.sortParticles=!0,e.object3D.add(n),e.obj={particles:i,geometry:o,pointCloud:n}}for(var a in e.obj.particles)e.update(e.obj.particles[a],t);e.obj.geometry.verticesNeedUpdate=!0,e.obj.geometry.computeBoundingSphere()}function L(e,t){return Kt.set(.2*Math.random()-.1,0,.2*Math.random()-.1).applyAxisAngle(He[$t[t]],ei[t]*H/2).add(e)}function X(e,t){var i=1*e.data.fillSpeed+1.5*Math.random(),o=Math.random()*H*2,n=Math.random()*H/2/2/2;return _t.set(0,i,0).applyAxisAngle(Ht,n).applyAxisAngle(Jt,o).applyAxisAngle(He[$t[t]],ei[t]*H/2)}function R(e){return e.push(e.shift())}function O(e,t,i){return Math.max(N(e,i),t)}function Q(e,t){var i=Math.sign,o=J(e.x),n=J(e.y),a=J(e.z),r=o>n,s=n>a,l=o>a,c=0,p=0,d=0;return t?(t.x&&(s?p=1:d=1),t.y&&(l?c=1:d=1),t.z&&(r?c=1:p=1)):r?l?c=1:s?p=1:d=1:s?p=1:l?c=1:d=1,new te.Vector3(c*i(e.x),p*i(e.y),d*i(e.z))}function U(){si?(c("lose"),T("You gave up")):(si=!0,k(vt?"Long-press the trackpad again to give up":"Press L again to give up"),c("warn"))}function q(){Ee.object3D.getWorldPosition(wi),f(wi),window.dispatchEvent(new Event("teleported"))}var N=Math.min,_=Math.floor,K=Math.cos,H=Math.PI,J=Math.abs,$=Math.sin,ee=new function(){var e,t,i,o,n,a,r,s,l,c,p,d;this._params=new function(){this.setSettings=function(e){for(var t=0;24>t;t++)this[String.fromCharCode(97+t)]=e[t]||0;.01>this.c&&(this.c=.01);var i=this.b+this.c+this.e;if(.18>i){var o=.18/i;this.b*=o,this.c*=o,this.e*=o}}},this.reset=function(){var e=this._params;o=100/(e.f*e.f+.001),n=100/(e.g*e.g+.001),a=1-e.h*e.h*e.h*.01,r=-e.i*e.i*e.i*1e-6,e.a||(p=.5-e.n/2,d=5e-5*-e.o),s=1+e.l*e.l*(0<e.l?-.9:10),l=0,c=1==e.m?0:(1-e.m)*(1-e.m)*2e4+32},this.totalReset=function(){this.reset();var o=this._params;return e=o.b*o.b*1e5,t=o.c*o.c*1e5,i=o.e*o.e*1e5+12,3*(0|(e+t+i)/3)},this.synthWave=function(u,h){var m=this._params,w=1!=m.s||m.v,y=m.v*m.v*.1,f=1+3e-4*m.w,v=m.s*m.s*m.s*.1,b=1+1e-4*m.t,g=1!=m.s,x=m.x*m.x,M=m.g,S=m.q||m.r,E=m.r*m.r*m.r*.2,k=m.q*m.q*(0>m.q?-1020:1020),j=m.p?32+(0|(1-m.p)*(1-m.p)*2e4):0,z=m.d,D=m.j/2,Z=m.k*m.k*.01,A=m.a,P=e,V=1/e,W=1/t,G=1/i,C=5/(1+m.u*m.u*20)*(.01+v);.8<C&&(C=.8),C=1-C;for(var Y,B,T,F,I,L,X=!1,R=0,O=0,Q=0,U=0,q=0,N=0,_=0,K=0,H=0,ee=0,te=Array(1024),ie=Array(32),oe=te.length;oe--;)te[oe]=0;for(oe=ie.length;oe--;)ie[oe]=2*Math.random()-1;for(oe=0;oe<h;oe++){if(X)return oe;if(j&&++H>=j&&(H=0,this.reset()),c&&++l>=c&&(c=0,o*=s),(o*=a+=r)>n&&(o=n,0<M&&(X=!0)),B=o,0<D&&(B*=1+$(ee+=Z)*D),8>(B|=0)&&(B=8),A||(0>(p+=d)?p=0:.5<p&&(p=.5)),++O>P)switch(O=0,++R){case 1:P=t;break;case 2:P=i}0==R?Q=O*V:1==R?Q=1+2*(1-O*W)*z:2==R?Q=1-O*G:3==R&&(Q=0,X=!0),S&&(0>(T=0|(k+=E))?T=-T:1023<T&&(T=1023)),w&&f&&(1e-5>(y*=f)?y=1e-5:.1<y&&(y=.1)),L=0;for(var ne=8;ne--;){if(++_>=B&&(_%=B,3==A))for(var ae=ie.length;ae--;)ie[ae]=2*Math.random()-1;0===A?I=_/B<p?.5:-.5:1===A?I=1-_/B*2:2===A?I=.225*((0>(I=1.27323954*(F=6.28318531*(.5<(F=_/B)?F-1:F))+.405284735*F*F*(0>F?1:-1))?-1:1)*I*I-I)+I:3===A&&(I=ie[J(0|32*_/B)]),w&&(Y=N,0>(v*=b)?v=0:.1<v&&(v=.1),g?(q+=(I-N)*v,q*=C):(N=I,q=0),U+=(N+=q)-Y,I=U*=1-y),S&&(te[K%1024]=I,I+=te[(K-T+1024)%1024],K++),L+=I}L*=.125*Q*x,u[oe]=1<=L?32767:-1>=L?-32768:0|32767*L}return h}};window.jsfxr=function(e){ee._params.setSettings(e);var t=ee.totalReset(),i=new Uint8Array(4*(0|(t+1)/2)+44),o=2*ee.synthWave(new Uint16Array(i.buffer,44),t);return new Uint32Array(i.buffer,0,44).set([1179011410,o+36,1163280727,544501094,16,65537,44100,88200,1048578,1635017060,o]),URL.createObjectURL(new Blob([i],{type:"audio/wav"}))};var te=window.THREE,ie=window.jsfxr,oe=window.TWEEN,ne=window.AFRAME;const ae=new te.Vector3(1,1,1),re=35071,se=.5,le=(ae.clone().multiplyScalar(se),.175*se),ce=50,pe=8947848;var de,ue,he,me,we,ye,fe,ve,be,ge,xe,Me,Se,Ee,ke,je,ze,De=i(!1),Ze=i(!0),Ae=[t(.5),t(.2)],Pe=o(),Ve=o(),We=function(){var{canvas:t,ctx:i}=e(256);i.fillStyle="#888",i.fillRect(0,0,255,255),i.lineWidth=2,i.rotate(H/4),i.translate(0,-192);for(var o=0;8>o;o++)for(var n=0;12>n;n++)for(var a=0;4>a;a++)i.strokeStyle="#aaa",i.beginPath(),i.moveTo(0+64*o,5*a+32*n),i.lineTo(16+64*o,5*a+32*n),i.stroke(),i.strokeStyle="#ccc",i.beginPath(),i.moveTo(0+64*o+32+5*a,0+32*n),i.lineTo(0+64*o+32+5*a,16+32*n),i.stroke();return new te.CanvasTexture(t,300,1e3,1e3)}(),Ge=Array(8).fill(0).map(()=>(function(){var{canvas:t,ctx:i}=e(256);i.strokeStyle="#70a6ff",i.shadowColor="#fff",i.save();for(var o=0;20>o;o++)n(i,3,128,128,Math.random()*H*2,Math.PI,50*Math.random()-25+50,3);return new te.CanvasTexture(t)})()),Ce=new te.MeshStandardMaterial({color:pe,side:2,map:Pe}),Ye=new te.MeshStandardMaterial({color:pe,side:2,map:Ve}),Be=new te.MeshStandardMaterial({color:pe,side:2,map:We}),Te=new te.MeshStandardMaterial({color:pe,side:2}),Fe=new te.MeshStandardMaterial({color:"#eee",side:1,transparent:!0,opacity:.3,emissive:16777215}),Ie=new te.Vector3,Le=new te.Vector3,Xe=()=>{var e=qe[lt];Ie.set(...e),Pe.repeat.set(Ie.x/2,4),Ve.repeat.set(Ie.z/2,4),We.repeat.set(Ie.x/2,Ie.z/2),Le.copy(Ie).multiplyScalar(se);const t="intro"===lt;var i=[e[0]+1-.6,e[1]+1-.6,e[2]+1-.6],o=new te.Mesh(new te.BoxGeometry(...i,1),[Ye,t?Fe:Ye,Be,Be,Ce,Ce]);if(o.position.copy(Ie).multiplyScalar(.5).addScalar(1),t){for(var n,a=0;4>a;a++)(n=new te.Mesh(new te.BoxGeometry(.75,6.4,11),[Ye,Te,Te,Te,Te,Te])).position.set(a%2*.01-5.001,(1-a)%2*4.3,(a-2)%2*8.8),n.rotation.x=H*(2===a?1:0),o.add(n);var r=new te.Geometry;for(a=0,i=5e3;2e3>a;a++){var s=Math.random()**.75*i/2,l=Math.random()*H*2;r.vertices.push(new te.Vector3(Math.random()*i/10-800,$(l)*s,K(l)*s))}o.add(new te.Points(r,new te.PointsMaterial))}ze.object3D.add(o)},Re={intro:["011xXYYX","201yg2^Y0YYXyx","411yYX","511yYYxy","611XYYX","721XyX","731yX","930z2^ZZ0Zyyz","922yY","944Y2yyyZYYYY","917ZzYYZZZZ","908yYYY","93bZ2^z0yyz","160z1WZZZZZZZZZZZZ","150z1WZZZZZZZZZZZZ","14bZ1^Wz"],room1:["130z2ZZZZZZGZ","230z1ZZ^Z0SZZZGZ","022x1XXX^X0SXXSXXGX","622yY","601y2rYXZyGy","602y2rYxxxxyGy"],room2:["032x1/gXX^X0SXXXXXGX","520z2/gZ^Z0SZSZSZZGZ","105y1WYY^Y","336z0WGZ"],room3:["202y2r^Y","854y0GY","345Z1W^z","610Z0WGz","604y2YYYYYGY","551Y8gyyyyyGy"],room4:["320z1/Z^Z","420z2Z^Z","530z1W^Z","448zZZ0GZ","548zZZ0GZ","358yW0GY","114yYYY","115yWYYY"]},Oe={intro:{pos:[5,.5,9],dir:[0,H/4,0]},room1:{pos:[6,.5,4],dir:[0,H/4,0]},room2:{pos:[6,.5,3],dir:[0,H/4,0]},room3:{pos:[4,.5,4],dir:[0,H/4,0]},room4:{pos:[4,.5,4],dir:[0,H/4,0]}},Qe={intro:[],room1:["-x>+x","-y>+y"],room2:["-x>+x","-y>+y","-y>+z","+y>-x"],room3:["-x>+x","-y>+y","-y>+z","+y>-x"],room4:["-y>+z","+y>-x"]},Ue={intro:!1,room1:!1,room2:!0,room3:!0,room4:!0},qe={intro:[9,6,10],room1:[7,4,5],room2:[7,4,5],room3:[9,4,4],room4:[7,4,9]};var Ne=r(.1),_e=r(0),Ke=r(.02),He={"+x":new te.Vector3(1,0,0),"-x":new te.Vector3(-1,0,0),"+y":new te.Vector3(0,1,0),"-y":new te.Vector3(0,-1,0),"+z":new te.Vector3(0,0,1),"-z":new te.Vector3(0,0,-1)},Je=(a([["+y",[1,0,0]],["-y",[-1,0,0]],["+z",[0,1,0]],["-z",[0,-1,0]],["+x",[1,0,0]],["-x",[-1,0,0]]]),{"-x":"+z","+x":"+z","-y":"+y","+y":"+y","-z":"+x","+z":"+x"}),$e={"-x":"+y","+x":"+y","-y":"+x","+y":"+x","-z":"+x","+z":"+x"},et={"-x":-1,"+x":1,"-y":1,"+y":-1,"-z":2,"+z":0},tt={x:"X",X:"x",y:"Y",Y:"y",z:"Z",Z:"z"},it={x:"-x",X:"+x",y:"-y",Y:"+y",z:"-z",Z:"+z"},ot={"-":"+","+":"-"},nt={};l("fill-next",[0,,.0147,.4249,.4668,.6611,,,,,,.4497,.6119,,,,,,1,,,,,.5]),l("place",[0,,.0458,.4093,.138,.5686,,,,,,,,,,,,,1,,,,,.5]),l("remove",[0,,.1476,.0523,.3758,.5554,.0027,-.4491,,,,,,.5355,-.6771,,.0444,-.0065,1,,,.0527,,.5]),l("win",[0,,.0933,.527,.4935,.8242,,,,,,.221,.6077,,,,,,1,,,,,.5]),l("lose",[0,.0075,.1024,.5235,.8863,.5433,,-.7012,-.1184,.4248,.4375,-.8011,.1484,.1565,-.1495,.8906,.3208,.2664,.3981,-.0033,-.4648,4e-4,-.1169,.5]),l("notice",[2,8e-4,.0718,.0181,.6147,.3236,,-.0572,.7976,,.5104,.8783,.8249,.762,-.0573,.6483,-.184,-.0645,.7087,-.5083,,.0066,.2721,.5]),l("zap",[0,.4405,.01,.3221,.2943,.5842,,.5361,.5834,.0991,-.1122,.2115,.4555,,-.5842,.8535,.666,-.9759,.8609,-.2102,.925,.7556,,.5]),l("warn",[2,.0075,.8721,.3728,.6914,.5,,-.0056,-.7544,-.7663,-.983,.0774,.3114,-.9683,-.1861,.7659,-.1718,.0255,.9996,-.6681,.1984,.2018,.6074,.5]),l("teleport",[0,.034,.4499,.1862,.5786,.1709,,-.0272,.0442,-.014,,-.3739,.6,,.6944,.7795,,.7813,.0327,.3626,.8632,.1002,-.1566,.5]);var at,rt,st,lt,ct,pt,dt,ut,ht=(localStorage.highScores||"").split(",").map(e=>+e),mt=0,wt=0,yt=0,ft=new te.Vector3,vt=!1,bt=!0,gt=[],xt=1,Mt=[],St=!1,Et={},kt=!1,jt=!1,zt=!0,Dt="",Zt={};Zt.room2=B("room2","Fix the pipes and the wire. Don't let the shield goop touch the live end of a wire","Shields are back online and warming up","room3"),Zt.room3=B("room3",null,"Weapons powering up","room4"),Zt.room4=B("room4",null,"Crew, we are back at 100%! Time to try another wormhole!",null);var At=new te.Vector3(.5,.5,.5),Pt=new te.MeshStandardMaterial({color:8947882,transparent:!0,opacity:.6,emissive:7500402}),Vt=new te.MeshStandardMaterial({color:8947882,transparent:!0,opacity:.6,emissive:7500402,side:1}),Wt=new te.MeshStandardMaterial({color:65280,emissive:7500402}),Gt=new te.MeshStandardMaterial({color:10521856,roughness:.87,metalness:.11}),Ct=new te.PointsMaterial({size:.1*se/2*window.devicePixelRatio,side:2,transparent:!0,opacity:.75,alphaTest:.1,map:De}),Yt=(new te.Vector3,new te.Vector3(0,0,1)),Bt=new te.Vector3,Tt=new te.Vector3,Ft=new te.Vector3,It=new te.Vector3,Lt=1,Xt=20;ne.registerComponent("pipe",{schema:{fillSpeed:{type:"number",default:1}},init:function(){var e=this.data;if(e.color=e.color||re,e.isFlowingForward=!0,e.isSource&&gt.push(this),e.place){var t=this.el.object3D.position,i=at[16*t.x*16+16*t.y+t.z];i&&(i.parentNode.removeChild(i),p(-10)),at[16*t.x*16+16*t.y+t.z]=this.el,this.checkGoals=!0}this.updateMesh(this.data.kind,this.data.isWire),this.bubbles={object3D:document.getElementById("b").object3D,count:30,material:Ct,renderOrder:10,create:()=>({t:10*Math.random()-9,theta:Math.random()*H*2,r:.125*Math.random(),position:new te.Vector3,source:this}),update:(e,t)=>{var i=O(e.t,0,999),o=_(i),n=e.source.pipes[o];if(n&&i%1<=n.amount){!function(e){var t=O(e.t,0,999),i=_(t),o=e.source.pipes[i],n=t%1,a=o.data.isFlowingForward?n:1-n,r=o.fullCurve.getTangent(a);e.normal=e.normal||o.frenetFrames.normals[_(t/10)].clone(),Ot.crossVectors(r,e.normal),e.normal.crossVectors(Ot,r).normalize(),Qt.copy(e.normal).applyAxisAngle(r,e.theta).normalize().multiplyScalar(e.r),o.fullCurve.getPoint(a,e.position).add(o.pos).add(Qt)}(e);const i=.008*n.data.fillSpeed*xt*t/1e3*60;e.t+=i}else e.t=10*Math.random()-9,e.normal=null}}},updateMesh:function(e,t){if(e){var[i,o]=e.split(">");this.amount=this.data.amount||0,this.lastAmount=this.amount,this.kind=e,this.isFilling=this.data.isFilling,this.isNextFilling=!1,this.data.isWire=t;var n=this.el.object3D;n.children=[];var[a,r,l,c,p]=this.data.isWire?[.07,.05,.04,.04,.02]:[.25,.2,.151,.15,.1],d=this.data.isWire?Ke:Ne;this.fullCurve=new te.QuadraticBezierCurve3(_e[i],At,_e[o]),this.frenetFrames=this.fullCurve.computeFrenetFrames(10);var u=new te.QuadraticBezierCurve3(d[i],At,d[o]);this.tubeMaterial=this.data.place?(t?Gt:Pt).clone():Wt.clone();var m=F(new te.TubeBufferGeometry(u,20,r),this.tubeMaterial,2),w=F(new te.TubeBufferGeometry(this.fullCurve,20,l),Vt,1);n.add(m,w);for(var f=new te.CylinderGeometry(a,a,p,8,1,!0),v=new te.RingGeometry(l,a,8),b=new te.RingGeometry(r,a,8),g=0;2>g;g++){var x=[i,o][g],M=s(x),S=F(f,this.tubeMaterial,2);S.rotateOnAxis(He[Je[x]],H/2),S.position.copy(_e[x]).add(He[M].clone().multiplyScalar(p/2));var E=F(v,this.tubeMaterial,2);E.rotateOnAxis(He[$e[x]],et[x]*H/2),E.position.copy(_e[x]);var k=F(b,this.tubeMaterial,2);k.rotateOnAxis(He[$e[x]],et[x]*H/2+H),k.position.copy(d[x]),n.add(S,k,E)}if(h(this.el.object3D.position)){var j=new te.Mesh(new te.PlaneGeometry,Ae[t?1:0]);j.rotateOnAxis(He[$e[i]],et[i]*H/2),j.position.set(.5,.5,.5).add(He[i].clone().multiplyScalar(.31*(this.data.isSource?-1:1))),n.add(j)}if(this.geometry=new te.TubeBufferGeometry(this.fullCurve,200,c),this.updateDrawRange(),this.material=new te.MeshToonMaterial({color:this.data.color,transparent:!0,opacity:.75}),this.mesh=F(this.geometry,this.material,3),this.mesh.position.copy(this.el.components.position.attrValue),this.endCap=F(new te.CircleGeometry(c),this.material,3),this.mesh.add(this.endCap),this.updateEndCap(),document.getElementById("L").object3D.add(this.mesh),this.data.isWire&&this.data.place){this.sparkMaterial=new te.PointsMaterial({map:Ge[te.Math.randInt(0,7)],transparent:!0,alphaTest:.01,depthWrite:!1,size:se/2*window.devicePixelRatio});var z=new te.Geometry;z.vertices.push(hi),this.spark=new te.Points(z,this.sparkMaterial),this.spark.renderOrder=199,n.add(this.spark)}this.updateDirs(e),y()}},tick:function(e,t){if(this.checkGoals){const e=y();xt=e===gt.length?10:1,e===gt.length&&c("fill-next"),this.checkGoals=!1}if(lt&&this.geometry){if(this.tickBubbles(t),this.data.isWire&&this.data.place){if(!this.next&&m(this.flowTo)&&this.isFilling){this.sparkMaterial.size=1===this.amount?se/2*window.devicePixelRatio:0;var i=this.el.object3D.position.y+this.spark.position.y;bt&&ye.position.y>i&&(c("zap"),T("You were electrocuted when a live wire touched the liquid"))}else this.sparkMaterial.size=1===this.amount?.2*se/2*window.devicePixelRatio:0;.6>Math.random()&&(this.sparkMaterial.opacity=N(2*Math.random(),1),this.sparkMaterial.map=Ge[te.Math.randInt(0,7)])}if(this.isFilling&&(this.amount=N(this.amount+.003*this.data.fillSpeed*xt*t/1e3*60,1)),.02<=this.amount-this.lastAmount)this.updateDrawRange(),this.lastAmount=this.amount,this.updateEndCap();else if(1===this.amount&&this.isFilling&&!this.isNextFilling)if(this.updateDrawRange(),this.lastAmount=this.amount,this.updateEndCap(),this.data.isGoal)this.isFilling=!1,gt.every(e=>e.reachesGoal&&1===e.pipes[e.pipes.length-1].amount)&&(p(yt),bt=!1,c("win"),window.dispatchEvent(new CustomEvent("finish-level",{detail:!0})));else{var o=this.next;if(o){if(St)p(100+wt),wt+=50;o.isFilling=!0,o.amount=0,o.material.color.set(this.data.color);var n=o.dirs.pipe.indexOf(s(this.dirs.flow[1]));o.data.isFlowingForward=0===n,o.updateDirs(),o.data.fillSpeed=this.data.fillSpeed,o.data.color=this.data.color,this.el.components.sound&&this.el.components.sound.stopSound(),this.isFilling=!1,this.isNextFilling=!0,this.overflow&&this.el.object3D.remove(this.overflow.obj.pointCloud)}else this.data.isWire?this.el.components.sound||(this.el.setAttribute("sound",{src:"url("+ie([0,.2195,.4246,.1583,.2072,.0883,,.0949,.0035,-.4383,-.4315,-.0843,.1909,.1572,.0053,-.2627,-.7051,.1504,.8556,-3e-4,.0137,,,.4])+")",loop:!0,refDistance:Lt,rolloffFactor:Xt}),this.el.components.sound.playSound()):(this.overflow||(wt=0,p(0)),function(e,t){if(!e.isGoal){if(jt=!0,ct){var i=3e-4*e.data.fillSpeed*t/1e3*60;Et[e.data.color]=(Et[e.data.color]||0)+i}if(e.el.object3D.getWorldPosition(ti),!e.overflow){var o=e.dirs.flow[1],n=e.fullCurve.getPoint(e.data.isFlowingForward?1:0);e.overflow={object3D:e.el.object3D,count:ce,material:new te.PointsMaterial({color:e.data.color,size:le/2*window.devicePixelRatio,transparent:!0,opacity:.5,alphaTest:.4,map:Ze}),renderOrder:99,create:()=>({t:.5*Math.random()+.5,position:L(n,o).clone(),velocity:X(e,o).clone()}),update:(t,i)=>{var a=i/1e3,r=(ti.y+t.position.y*se).y<Gi.y;Nt.copy(r?qt:Ut).multiplyScalar(a),t.t,t.t-=a,0>t.t&&(t.t=.5*Math.random()+.5,t.position.copy(L(n,o)),t.velocity.copy(X(e,o))),r||t.velocity.add(Nt),t.velocity.x*=r?.95:1,t.velocity.y*=r?.8:1,t.velocity.z*=r?.95:1,t.position.add(_t.copy(t.velocity).multiplyScalar(a))}},e.el.setAttribute("sound",{src:"url("+ii()+")",loop:!0,refDistance:Lt,rolloffFactor:Xt}),e.el.components.sound.playSound()}I(e.overflow,t)}}(this,t))}}},updateDirs:function(){this.dirs={pipe:this.kind.split(">"),flow:this.data.isFlowingForward?this.kind.split(">"):this.kind.split(">").reverse()},this.pos=this.el.object3D.position.clone().floor(),this.flowRel=He[this.dirs.flow[1]],this.flowTo=ft.copy(this.pos).add(this.flowRel).clone(),this.spark&&this.spark.position.copy(_e[this.dirs.flow[1]])},tickBubbles:function(e){!this.data.isSource||this.spark||I(this.bubbles,e)},updatePipes:function(){(this.pipes||[]).forEach(e=>e.next=null),this.pipes=[];for(var e,t=this,i=s(t.dirs.flow[1]),o=0;t&&!t.data.isGoal&&30>o;){o++,t.source=this,this.pipes.push(t);var n=t;if(t=w(t.flowTo,this)){if(-1===(e=t.dirs.pipe.indexOf(i)))break;n.next=t,t.data.isFlowingForward=0===e,t.updateDirs(),t.data.fillSpeed=this.data.fillSpeed,t.data.color=this.data.color,i=s(t.dirs.pipe[1-e])}}this.reachesGoal=-1<e&&t&&t.data.isGoal},updateEndCap:function(){var e=0===this.amount||1===this.amount&&!this.isFilling&&this.isNextFilling;if(this.endCap.visible=!e,!e){var t=e=>this.data.isFlowingForward?this.amount-e:1-this.amount+e,i=t(0),o=t(.01);this.fullCurve.getPoint(o,Tt),this.fullCurve.getPoint(i,Ft),this.fullCurve.getPoint(t(.005),It),Bt.copy(Ft).sub(It).normalize(),this.endCap.quaternion.setFromUnitVectors(Yt,Bt),this.endCap.position.copy(Tt)}},updateDrawRange:function(){var e=9648,t=48*_(this.amount*e/48),i=this.data.isFlowingForward;this.geometry.setDrawRange(i?0:e-t,i?t:e)}});var Rt,Ot=new te.Vector3,Qt=new te.Vector3,Ut=new te.Vector3(0,-9.8,0),qt=new te.Vector3(0,3,0),Nt=new te.Vector3,_t=new te.Vector3,Kt=new te.Vector3,Ht=new te.Vector3(1,0,0),Jt=new te.Vector3(0,1,0),$t={"+x":"+z","-x":"+z","+y":"+z","-y":"+z","+z":"+x","-z":"+x"},ei={"+x":-1,"-x":1,"+y":0,"-y":2,"+z":1,"-z":-1},ti=new te.Vector3,ii=(new te.Vector3,new te.Vector3,()=>ie([3,.7354,.1097,.045,.4548,.635,.0166,.017,.0314,.7644,4e-4,.2392,,.5291,-.1974,,.0292,.0366,.6863,6e-4,.3234,.0303,-.0559,.5])),oi=new te.Color,ni=(new te.Vector3,new te.PlaneBufferGeometry(12,12,12,12)),ai=new te.MeshStandardMaterial({color:re,transparent:!0,opacity:0,side:2}),ri=F(ni,ai,50);ne.registerComponent("w",{init:function(){this.el.object3D.add(ri)},tick:function(e){if(ct){if(jt){var t=0;for(var i in Et)t+=Et[i];var o=0,n=0,a=0;for(var i in Et){oi.set(parseInt(i));var r=Et[i]/t;o+=oi.r*r,n+=oi.g*r,a+=oi.b*r}oi.setRGB(o,n,a);var s=N(t,.3);this.el.object3D.position.y=.8+t,ai.color.copy(oi),ai.opacity=10*s/3*.7,"intro"===lt?this.el.object3D.position.y=N(this.el.object3D.position.y,1.5):bt&&this.el.object3D.position.y>Ie.y+1&&(c("lose"),T("You drowned"))}jt=!1;var l=O(1e3-10*_(100*(this.el.object3D.position.y-.81)/3),0,1e3);l!==yt&&(yt=l,p(0));for(var d=e/1e3*20,u=0,h=0;12>=h;h++)for(var m=0;12>=m;m++,u++)ni.attributes.position.array[3*u+2]=.05*.7*($(.3*(h+d))+$(.5*(m+d)));ni.attributes.position.needsUpdate=!0,lt&&!zt&&((Rt=Wi.y<Gi.y+.05)?(he.opacity=.85,he.needsUpdate=!0,he.blending=4):he.blending=2,ue.visible=Rt)}},reset:function(){this.el.object3D.position.y=.7,ai.opacity=0,Et={}}});var si,li,ci,pi,di,ui,hi=new te.Vector3,mi={q:{rot:!0,rotAlt:!1},r:{rot:!1,rotAlt:!0},e:{rot:!1,rotAlt:!1},f:{rot:!0,rotAlt:!0}},wi=new te.Vector3,yi=new te.Vector3;const fi="You already have an active (green) pipe or wire. Snap it into place before grabbing or creating a new one";var vi,bi,gi=new te.Vector3,xi=new te.Vector3,Mi=new te.Quaternion,Si=new te.Quaternion,Ei=new te.Vector3,ki=new te.Quaternion,ji=new te.Quaternion;ne.registerComponent("c",{init:function(){this.pipe=document.getElementById("c"),this.pipePipe=document.getElementById("C"),this.material=new te.LineBasicMaterial,this.el.object3D.add(new te.LineSegments(new te.EdgesGeometry(new te.BoxGeometry),this.material)),new te.LineBasicMaterial({transparent:!0,opacity:.6}),this.lines=new te.Group;for(var e=[1,0,0],t=0;3>t;t++)for(var i,o=0;2>o;o++){(i=new te.Geometry).vertices.push(hi),i.vertices.push(new te.Vector3(...e).clone().multiplyScalar(o?20:-20)),R(e),i.vertices.push(new te.Vector3(...e).clone().multiplyScalar(.2)),i.vertices.push(new te.Vector3(...e).clone().multiplyScalar(-.2)),R(e),i.vertices.push(new te.Vector3(...e).clone().multiplyScalar(.2)),i.vertices.push(new te.Vector3(...e).clone().multiplyScalar(-.2)),R(e);var n=new te.LineBasicMaterial({transparent:!0,opacity:.6}),a=new te.LineSegments(i,n);a.position.copy(new te.Vector3(...e).clone().multiplyScalar(o?.5:-.5)),this.lines.add(a),R(e)}this.el.object3D.add(this.lines),window.addEventListener("keydown",e=>this.rot(e.key)),this.el.sceneEl.canvas.addEventListener("mousedown",()=>this.click()),(je=document.getElementById("R")).addEventListener("trackpaddown",()=>ui=+new Date),je.addEventListener("trackpadup",()=>{2e3<+new Date-ui?U():(si=!1,this.placePipe(!1))}),je.addEventListener("thumbstickdown",()=>ui=+new Date),je.addEventListener("thumbstickup",()=>{1e3<+new Date-ui?U():(si=!1,this.placePipe(!1))}),this.el.sceneEl.addEventListener("enter-vr",()=>{vt=!0,xe.position.y=.8*se}),this.el.sceneEl.addEventListener("exit-vr",()=>{vt=!1,xe.position.y=2.1}),je.addEventListener("triggerup",()=>this.triggerUp()),je.addEventListener("triggerdown",()=>this.click())},release:function(){return window.dispatchEvent(new Event("click-triggered")),this.isGrabbing=!1,this.triggerDown=!1,St?void(!bi||(this.computeKind(),this.clamped&&this.placePipe(!0))):void(this.clamped=!1)},triggerUp:function(){si=!1,this.release()},click:function(){if(si=!1,window.dispatchEvent(new Event("click-triggered")),St){var e=xi;if(this.triggerDown=!0,li&&!bi){if(!di)return void j("You can only pick up an empty pipe or dead wire");var t=li.pos,i=at[16*t.x*16+16*t.y+t.z].components.pipe;bi=i.kind,this.isWire=i.data.isWire,at[16*t.x*16+16*t.y+t.z]=null,li.el.parentNode.removeChild(li.el),li=null,y(),p(-10),this.nextPipe(bi,this.isWire),this.pipe.object3D.position.copy(t).addScalar(.5),this.isGrabbing=!0}else{if(li)return void j(fi);if(bi)if(vt){var o=new te.Vector3;this.pipe.object3D.getWorldPosition(o);var n=o.distanceTo(e);if(this.isGrabbing=.5>n,!this.isGrabbing)return void j(fi)}else!vt&&this.isGrabbing&&this.clamped&&this.release();else this.nextPipe(),this.pipe.object3D.position.copy(e),this.pipe.object3D.parent.worldToLocal(this.pipe.object3D.position),this.isGrabbing=!0}this.pointer.object3D.updateMatrixWorld();var a=new te.Quaternion;this.pointer.object3D.getWorldQuaternion(a),a.inverse().multiply(Mi),ji.copy(a)}},computeKind:function(){var e=this.pipePipe.components.pipe;if(e.kind){var t=He[e.dirs.pipe[0]].clone(),i=He[e.dirs.pipe[1]].clone(),o=this.pipe.object3D.quaternion;t.applyQuaternion(o),i.applyQuaternion(o);for(var n=[],a=["x","y","z"],r=0;3>r;r++){var s=a[r],l=t,c=0,p=l.dot(He["+"+s]);.999<J(p)&&(n[c]=(0<p?"+":"-")+s),c=1;p=(l=i).dot(He["+"+s]);.999<J(p)&&(n[c]=(0<p?"+":"-")+s)}this.computedKind=n.join(">")}},nextPipe:function(e,t){if(lt){var i=Qe[lt];bi=e||i[_(Math.random()*i.length)],this.isWire=e?t:!rt||!(!st||!Ue[lt])&&0!==te.Math.randInt(0,1),this.pipe.object3D.rotation.copy(hi),this.pipePipe.components.pipe.updateMesh(bi,this.isWire),this.computeKind(),window.dispatchEvent(new Event("grab-pipe"))}},tick:function(){if(this.lines.visible=!vt,!bt||!St)return this.el.setAttribute("visible",!1),void this.pipe.setAttribute("visible",!1);this.pipe.setAttribute("visible",!!bi&&(vt||!li)),this.pointer=vt?je:fe;var e=this.pointer.object3D;e.updateMatrixWorld(),e.getWorldPosition(xi);var t=new te.Vector3;e.getWorldDirection(t);var i=vt?0:-1.25;t.normalize().multiplyScalar(i).add(xi),gi.copy(t);var o=.5<Wi.distanceTo(t);this.el.setAttribute("visible",o),vt&&this.isGrabbing&&(e.getWorldQuaternion(ki),Mi.multiplyQuaternions(ki,ji)),this.el.object3D.parent.worldToLocal(t),this.el.object3D.position.copy(t).floor().clamp(hi,Ie.clone().addScalar(1)).addScalar(.5);var n=(new te.Vector3).copy(t).floor().addScalar(.5),a=new te.Vector3,r=.4>n.distanceTo(t);a.copy(r?n:t);var s=(new te.Vector3).copy(a).floor(),l=u(s),c=!(l&&w(s))&&u(s);if(this.material.color.set(l?16777215:16711680),this.isGrabbing){li&&(li.tubeMaterial.color.set(ci),li.tubeMaterial.opacity=pi,li=null);var p=!vt;Si.copy(Mi),(new te.Vector3).copy(t).addScalar(.5);var d=Jt.clone(),h=Ht.clone(),m=Q(d.applyQuaternion(Mi)),y=Q(h.applyQuaternion(Mi),m),f=(new te.Vector3).crossVectors(y,m),v=J(d.angleTo(m)),b=J(h.angleTo(y)),g=v<H/2/3,x=b<H/2/3;if(("-x>+x"===bi||"+x>-x"===bi)&&x||("-y>+y"===bi||"+y>-y"===bi)&&g||x&&g){var M=(new te.Matrix4).makeBasis(y,m,f);Si.setFromRotationMatrix(M),p=!0}this.clamped=r&&p&&c,this.clamped?(vt&&this.pipe.object3D.quaternion.copy(Si),this.pipe.object3D.position.copy(a),this.pipePipe.components.pipe.tubeMaterial.color.set("#0f0"),Ei.copy(a).floor()):(vt&&this.pipe.object3D.quaternion.copy(Mi),this.pipe.object3D.position.copy(t).clamp(ae.clone(),Ie.clone().addScalar(1)),this.pipePipe.components.pipe.tubeMaterial.color.set("#484")),vi=l&&this.clamped,this.computeKind()}else{yi.copy(t).floor().clamp(hi,Ie);var S=.5>(new te.Vector3).copy(yi).addScalar(.5).distanceTo(t),E=w(yi);if(S&&E&&!bi){li&&(li.tubeMaterial.color.set(ci),li.tubeMaterial.opacity=pi,li=null);var k=0===E.amount;li=E,ci=E.tubeMaterial.color.clone(),pi=E.tubeMaterial.opacity,di=k,li.tubeMaterial.color.set(k?65280:16711680),li.tubeMaterial.opacity=1}else li&&(li.tubeMaterial.color.set(ci),li.tubeMaterial.opacity=pi,li=null)}},placePipe:function(e){if(window.dispatchEvent(new Event("click-triggered")),Ee.getAttribute("visible"))q();else if(e&&bt&&vi&&u(Ei)){this.computeKind();var t=document.createElement("a-entity");t.setAttribute("position",Ei.clone()),t.setAttribute("pipe",{kind:this.computedKind,isWire:this.isWire,place:!0}),document.getElementById("p").appendChild(t),window.dispatchEvent(new Event("place-pipe")),c("place"),bi=null,this.pipe.setAttribute("visible",!1)}},rot:function(e){if(bt){if("l"===e)return void U();if(si=!1,bi){var t=mi[e];if(t){var i=new te.Quaternion;this.pointer.object3D.updateMatrixWorld(),this.pointer.object3D.getWorldQuaternion(i);var o=Q((t.rotAlt?Ht:Jt).clone().applyQuaternion(i)),n=(vt?-1:1)*(t.rotAlt?1:-1)*(t.rot?1:-1)*H/2;this.tween&&this.tween.end(),this.pipe.object3D.updateMatrixWorld();var a=this.pipe.object3D.quaternion.clone(),r=(new te.Quaternion).setFromAxisAngle(o,n).multiply(a).normalize(),s=this.pipe.object3D.quaternion,l={t:0};this.tween=new oe.Tween(l).to({t:1},300).onUpdate(()=>te.Quaternion.slerp(a,r,s,l.t)).start()}}}}});var zi,Di,Zi,Ai=!1,Pi=new te.Vector3;ne.registerComponent("l",{init:function(){this.el.addEventListener("trackpadtouchstart",()=>Ai=!0),this.el.addEventListener("trackpadtouchend",()=>Ai=!1),this.el.addEventListener("thumbsticktouchstart",()=>Zi=!0),this.el.addEventListener("axismove",e=>{Zi&&kt&&(.8<J(e.detail.axis[1])?(Ai=!0,zi=!0):zi?(q(),zi=!1):Ai=!1,.8<e.detail.axis[0]?(!Di&&(xe.rotation.y-=H/4),Di=!0):-.8>e.detail.axis[0]?(!Di&&(xe.rotation.y+=H/4),Di=!0):Di=!1)}),this.raycaster=this.el.components.raycaster},tick:function(){var e=!1;if(kt&&vt&&Ai){this.raycaster.updateOriginDirection(),this.raycaster.raycaster.far=4*se;var t=this.raycaster.raycaster.intersectObject(ke.object3D,!0)[0];if(t){var i=new te.Vector3;Pi.copy(t.point).clamp(ae.clone().addScalar(.6).multiplyScalar(se),i.copy(Ie).addScalar(.4).multiplyScalar(se)),Pi.y=.81*se,5>t.distance&&(Ee.setAttribute("position",Pi),e=!0)}}Ee.setAttribute("visible",e)}});var Vi=new te.Vector3,Wi=new te.Vector3,Gi=new te.Vector3;new te.Vector3;ne.registerComponent("g",{init:function(){de=document.getElementById("a"),ue=de.object3D,he=de.components.material.material,me=document.getElementById("w"),we=me.components.w,ye=me.object3D,fe=document.getElementById("m"),ve=fe.object3D,be=document.getElementById("t").object3D,ge=document.getElementById("r"),xe=ge.object3D,Me=document.getElementById("d"),Se=document.getElementById("p"),Ee=document.getElementById("F"),ke=document.getElementById("f"),ze=document.getElementById("l"),de.object3DMap.mesh.renderOrder=199,he.blending=2,[Me,document.getElementById("I")].forEach(e=>{e.object3DMap.text.renderOrder=999,e.object3DMap.text.material.depthTest=!1}),ve.getWorldPosition(Wi),ye.getWorldPosition(Gi),async function(){for(;;)document.getElementById("h").setAttribute("text",{value:"High Scores\n\n"+ht.map((e,t)=>t+1+".\t\t"+e.toLocaleString()+(e===mt?" <<":"")).join("\n")}),dt=!1,ct=!0,kt=!1,document.getElementById("s").setAttribute("visible",!1),await D(.1),v("intro"),await g("#000",0,1,1e3),await D(.1),St=!1,b(),await k("[click to start]",!0),await D(1),await z("Crew, we just exited the wormhole. Everyone to stations and check ship status."),vt?(kt=!0,await D(1),M("Aim at the floor and press the thumbpad/thumbstick to move"),await P(),M("Good! Enter the white teleporter circle to start")):M("Use WASD + mouse. Enter the white teleporter circle to start"),await V(),S(),dt=!0,mt=0,wt=0,await g("#88f",1,0),await Y()}()},tick:function(){if(ve.getWorldPosition(Wi),ye.getWorldPosition(Gi),lt&&(vt||(Vi.copy(xe.position).clamp(ae,Le),Vi.y=xe.position.y,.001<xe.position.distanceTo(Vi)&&xe.position.copy(Vi)),!dt)){var e=(new te.Vector3).copy(Wi);ze.object3D.parent.worldToLocal(e),e.y=be.position.y,.8>be.position.distanceTo(e)&&window.dispatchEvent(new Event("start-game"))}}})</script><body><a-scene background=#000 antialias=true keyboard-shortcuts=enterVR:false g><a-entity scale=".5 .5 .5"><a-entity id=i><a-circle id=t position="5 .805 3.5" rotation="-90 0 0"></a-circle><a-box position="5.5 .5 .5" width=10 depth=3 color=#666></a-box><a-box position="10.5 5 5.5" width=3 height=2 depth=13 color=#666></a-box><a-entity id=h text=width:5 position="4.4 4.5 11.2" rotation="0 180 0"></a-entity></a-entity><a-entity id=s text=width:5 position="5.9 3.5 .8"></a-entity><a-entity id=l></a-entity><a-entity id=b></a-entity><a-entity id=L></a-entity><a-entity id=p></a-entity><a-entity c></a-entity><a-entity id=c><a-entity id=C pipe position="-.5 -.5 -.5"></a-entity></a-entity><a-entity id=w w position="6 .5 6" rotation="-90 0 0"></a-entity></a-entity><a-plane id=f position="5.5 .39 5.5" rotation="-90 0 0" width=11 height=11></a-plane><a-circle id=F rotation="-90 0 0" radius=.268 color=#f0f></a-circle><a-entity light=type:ambient;color:#888></a-entity><a-entity light=type:directional;intensity:.6 position="-1 1 0"></a-entity><a-entity light=type:point;intensity:.6 position="4 4 4"></a-entity><a-entity id=r wasd-controls look-controls=pointerLockEnabled:true><a-entity id=m camera><a-plane id=a position="0 0 -.6" width=3 height=2 color=#5b90ae opacity=.99 material=depthTest:false;shader:flat></a-plane><a-entity id=d text=width:1.2;align:center position=".05 -.1 -1.5" visible=false><a-plane width=1.5 height=.6 color=#000 opacity=.7 material=depthTest:false;shader:flat></a-plane></a-entity><a-entity id=I text=width:1.2;align:center position=".05 -.6 -1.5" visible=false><a-plane width=1.5 height=.25 color=#000 opacity=.7 material=depthTest:false;shader:flat></a-plane></a-entity></a-entity><a-entity id=R hand-controls=right raycaster="direction:0 0 -1" l></a-entity></a-entity></a-scene></body>